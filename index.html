<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
/>
<title>Andi's Starlight Garden 🌟</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Sacramento&display=swap" rel="stylesheet">

<link rel="manifest" href="manifest.json">

<!-- iOS Home Screen icon -->
<link rel="apple-touch-icon"
      href="https://appanda93.github.io/Andis-Starlight-Garden/apple-touch-icon-180x180.png?v=3">

<meta name="apple-mobile-web-app-title" content="Andi's Starlight Garden">

<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="48x48" href="favicon-48.png">
<link rel="icon" type="image/png" sizes="64x64" href="favicon-64.png">
<link rel="icon" type="image/png" sizes="192x192" href="favicon-192.png">

<meta name="theme-color" content="#e6c7ff">

<!-- iOS add-to-home goodies -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
  :root{
    --ink:#5b2b86;
    --panel:#fff7fb;
    --accent:#d8b4f8;
    --btn:#f7d9f0;
    --btn2:#e6c7ff;
    --shadow:rgba(200,150,255,.4);
  }
  html,body{height:100%}
  /* prevent iOS rubber-band + scroll chaining */
  html, body { overscroll-behavior-y: contain; }

  /* stabilized height on iOS */
  body{
    margin:0;
    display:grid;
    justify-items:center;
    align-items:start;
    min-height:100dvh; /* dvh to avoid address bar yo-yo */
    background:linear-gradient(135deg,#ffe6f0,#e6f7ff);
    color:var(--ink); font-family:'Poppins',sans-serif;
    position:relative;
    overflow-x:hidden;
    overflow-y:auto;
  }

  h1,h2,#scoreTop{font-family:'Sacramento',cursive}

  .firefly{
    position:absolute; width:6px;height:6px;border-radius:50%;
    background:#ffff99; box-shadow:0 0 8px 4px rgba(255,255,150,.6);
    animation:float 10s linear infinite; pointer-events:none; z-index:0;
  }
  @keyframes float{from{transform:translateY(100vh);opacity:0}50%{opacity:1}to{transform:translateY(-10vh);opacity:0}}

  .wrap{position:relative; z-index:2; width:min(960px,96vw); padding-bottom:24px}
  #topBar{display:flex; align-items:center; justify-content:space-between; gap:8px; padding-top:8px; flex-wrap:wrap}
  #scoreTop{font-size:32px; text-shadow:0 0 8px #ff99cc,0 0 12px #cc99ff,0 0 18px #ffe6ff}
  #musicBtn,#resetBtn,#howtoBtn,#themeBtn{
    padding:8px 12px; border:none; border-radius:10px; background:var(--btn);
    box-shadow:0 4px 8px rgba(0,0,0,.15); cursor:pointer; transition:.15s; font-weight:600;
  }
  #musicBtn:hover,#resetBtn:hover,#howtoBtn:hover,#themeBtn:hover{transform:scale(1.05); background:var(--btn2)}
  #bestBadge{font-size:14px; opacity:.85}

  /* ===== Garden title + rename ===== */
  .titleRow{
    margin: 6px 0 0;
    display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap;
  }
  .garden-title{
    margin: 0;
    text-align:center;
    font-size: 40px;
    line-height: 1.1;
    letter-spacing: .5px;
    text-shadow:0 0 8px #ff99cc66,0 0 12px #cc99ff66;
  }
  .renameBtn{
    border:none; border-radius:10px; padding:8px 10px;
    background:var(--btn); font-weight:600; cursor:pointer;
    box-shadow:0 4px 8px rgba(0,0,0,.12);
  }
  .renameBtn:hover{ transform:scale(1.04); background:var(--btn2) }
  .renameRow{
    display:flex; align-items:center; justify-content:center; gap:8px;
    margin:8px 0 0;
  }
  .renameRow input{
    min-width: 260px; max-width: 90vw;
    padding:10px 12px; border-radius:10px; border:2px solid var(--accent); background:#fff; font-size:16px;
  }
  .renameRow button{
    border:none; border-radius:10px; padding:8px 12px; background:var(--btn); font-weight:600; cursor:pointer;
    box-shadow:0 4px 8px rgba(0,0,0,.12);
  }
  .renameRow button:hover{ transform:scale(1.04); background:var(--btn2) }

  /* ===== Mythical Forest Board ===== */
  #garden{
    margin:10px 0 0; position:relative;
    border:4px solid var(--accent); border-radius:18px;
    box-shadow:0 10px 30px var(--shadow);
    min-height:340px; overflow:hidden;
    background:
      linear-gradient(180deg, #f6ecff 0%, #eaf7ff 40%, #eaf9f0 100%),
      url("icons8-star-64.png") repeat;
    background-size: auto, 64px 64px;
  }
  #garden::before, #garden::after{
    content:""; position:absolute; inset:0; pointer-events:none;
  }
  #garden::before{
    background:
      radial-gradient(120% 70% at 20% 110%, #d7f6da 0 55%, transparent 56%),
      radial-gradient(120% 70% at 80% 115%, #d1f0ff 0 55%, transparent 56%),
      radial-gradient(140% 90% at 50% 120%, #e6dbff 0 55%, transparent 56%);
    opacity:.8;
  }
  #garden::after{
    background:
      /* trunks */
      repeating-linear-gradient(90deg,
        rgba(150,120,200,.10) 0 6px, transparent 6px 46px),
      /* canopy blobs */
      radial-gradient(60px 40px at 10% 20%, rgba(160,220,180,.18) 0 55%, transparent 56%),
      radial-gradient(70px 48px at 30% 28%, rgba(150,200,210,.18) 0 55%, transparent 56%),
      radial-gradient(65px 45px at 55% 18%, rgba(180,160,220,.18) 0 55%, transparent 56%),
      radial-gradient(70px 50px at 80% 30%, rgba(160,220,190,.18) 0 55%, transparent 56%);
    mix-blend-mode:multiply;
  }

  /* Grid of forest plots */
  .plots{
    position:relative;
    display:grid; grid-template-columns:repeat(5,1fr); gap:10px;
    padding:14px;
    z-index:1;
  }

  /* Base plot style (soft card) */
  .plot{
    aspect-ratio:1/1; border-radius:16px;
    background:rgba(255,255,255,.75);
    border:2px solid rgba(216,180,248,.55);
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.5), 0 6px 12px rgba(0,0,0,.08);
    position:relative; overflow:hidden;
  }
  .spr{ position:absolute; font-size:28px; filter:drop-shadow(0 2px 3px rgba(0,0,0,.15)) }
  .float { animation:bob 3.2s ease-in-out infinite }
  @keyframes bob{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}

  /* ===== Biome themes ===== */
  .plot.glade{
    background:
      radial-gradient(140% 100% at 50% 120%, rgba(180,255,210,.45) 0 55%, rgba(180,255,210,0) 56%),
      radial-gradient(circle at 70% 20%, rgba(255,255,255,.6) 0 8%, transparent 9%),
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.5) 0 6%, transparent 7%),
      linear-gradient(180deg,#efffed,#e9fff5);
    border-color:#c5f2d6;
  }
  .plot.pond{
    background:
      radial-gradient(60% 60% at 50% 55%, rgba(255,255,255,.8) 0 8%, transparent 9%),
      radial-gradient(60% 60% at 30% 40%, rgba(255,255,255,.6) 0 6%, transparent 7%),
      radial-gradient(120% 120% at 50% 60%, #bfefff 0 52%, #a6e2ff 53% 60%, #b0f1ff 61% 100%);
    border-color:#a6def7;
    box-shadow:inset 0 0 0 3px rgba(255,255,255,.55), 0 6px 12px rgba(0,0,0,.06);
  }
  .plot.ring{
    background:linear-gradient(180deg,#f3fff0,#eafff5);
    border-color:#d1f7de;
  }
  .plot.ring::after{
    content:""; position:absolute; inset:14%; border-radius:50%;
    border:4px dotted #f0b7ff88;
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.6);
  }
  .plot.grove{
    background:
      radial-gradient(120% 100% at 40% 110%, #e4ffea 0 55%, transparent 56%),
      linear-gradient(135deg, rgba(170,210,180,.25), rgba(160,200,220,.25)),
      linear-gradient(180deg,#f1fff4,#e9fff8);
    border-color:#c9eccf;
  }
  .plot.crystal{
    background:
      linear-gradient(135deg, #eef2ff, #f6edff),
      conic-gradient(from 45deg at 30% 30%, rgba(180,160,255,.20), transparent 25%, rgba(200,180,255,.15) 0 50%, transparent 0 75%, rgba(220,200,255,.18) 0);
    border-color:#cfc2ff;
    box-shadow: inset 0 0 18px rgba(190,160,255,.25), 0 6px 12px rgba(0,0,0,.08);
  }

  /* Collect + shop (button in normal flow, under grid) */
  #collectBtn{
    width:100%; margin:12px 0 16px; padding:16px 18px; border:none; border-radius:14px;
    background:linear-gradient(135deg,#f7d9f0,#e6c7ff); color:var(--ink);
    font-weight:700; font-size:18px; box-shadow:0 6px 14px rgba(0,0,0,.15); cursor:pointer; transition:.15s;
    touch-action: manipulation; -webkit-user-select:none; -webkit-tap-highlight-color:transparent;
  }
  /* Desktop press effect */
  #collectBtn:active{ transform: scale(.98); }
  /* Touch devices: avoid transform to stop viewport jiggle */
  @media (hover: none) and (pointer: coarse){
    #collectBtn:active{ transform:none; filter:brightness(.96); }
  }

  .shop{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:10px}
  .card{
    background:var(--panel); border:3px solid var(--accent); border-radius:14px; padding:10px;
    box-shadow:0 6px 14px rgba(0,0,0,.12); text-align:center;
  }
  .card h3{margin:6px 0 4px; font-size:20px}
  .card p{margin:0; font-size:14px}
  .buyBtn{
    width:100%; margin-top:8px; padding:10px; border:none; border-radius:10px;
    background:var(--btn); cursor:pointer; transition:.15s; font-weight:600;
  }
  .buyBtn:hover{transform:scale(1.04); background:var(--btn2)}

  /* Start screen */
  #start{position:fixed; inset:0; display:grid; place-items:center;
    background:linear-gradient(135deg,#ffe6f0cc,#e6f7ffcc); z-index:15;}
  #start .panel{
    text-align:center; background:#fffafa; border:4px solid var(--accent); border-radius:16px;
    padding:18px 24px; box-shadow:0 10px 30px var(--shadow);
    max-width: 640px;
  }
  #start h1{font-size:56px; margin:0 0 6px; text-shadow:0 0 8px #ff99cc,0 0 12px #cc99ff}
  #start .best{margin:6px 0 12px; opacity:.85}
  #start button{font-weight:700; padding:10px 16px; border:none; border-radius:10px; background:var(--btn); cursor:pointer}
  #start button:hover{transform:scale(1.05); background:var(--btn2)}

  /* Start screen: name field */
  .nameRow{display:flex; gap:10px; margin-top:10px; align-items:center; justify-content:center; flex-wrap:wrap}
  .nameRow label{font-weight:600}
  .nameRow input{
    min-width: 260px;
    max-width: 90vw;
    padding:10px 12px;
    border-radius:10px;
    border:2px solid var(--accent);
    background:#fff;
    font-size:16px;
  }

  /* Confetti */
  #fxCanvas{position:fixed; inset:0; pointer-events:none; z-index:20;}

  /* Modal */
  .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:20px; z-index:100;}
  .modal{
    max-width:560px;width:100%; background:#fffafa; border:4px solid var(--accent);
    border-radius:16px; box-shadow:0 10px 30px rgba(200,150,255,.5); padding:20px;
  }
  .modal h2{margin:0 0 8px; font-size:36px; text-align:center; text-shadow:0 0 8px #ff99cc,0 0 12px #cc99ff}
  .modal ul{margin:8px 0 0 20px; padding:0; line-height:1.5; font-size:16px}
  .modal .actions{display:flex; justify-content:center; margin-top:12px}
  .modal button{padding:8px 12px; border:none; border-radius:10px; background:var(--btn); cursor:pointer}

  /* Responsive grid count */
  @media(max-width:560px){
    .shop{grid-template-columns:repeat(2,1fr)}
    .plots{grid-template-columns:repeat(4,1fr)}
  }

  /* ===== THEME: Moonlit Meadow ===== */
  body.theme-moon {
    --panel:#151a3a;
    --accent:#cbb2ff;   /* soft neon-lilac accents */
    --btn:#2b2f65;
    --btn2:#424a9e;
    --ink:#eae6ff;
    color:var(--ink);
    background:linear-gradient(135deg,#0f1024,#1c2250); /* deep indigo → midnight */
  }
  body.theme-moon #garden{
    background:
      linear-gradient(180deg,#171a3a 0%, #1e2b58 40%, #122039 100%), /* night gradient */
      radial-gradient(1px 1px at 20% 30%, #ffffffcc, transparent 70%) repeat, /* twinkles */
      radial-gradient(1px 1px at 70% 60%, #ffffff99, transparent 70%) repeat;
    background-size:auto, 64px 64px, 96px 96px;
    border-color: var(--accent);
    box-shadow:0 10px 30px rgba(100,80,200,.5);
  }
  body.theme-moon .plot{
    background:rgba(255,255,255,.08);
    border-color: rgba(203,178,255,.45);
    box-shadow:inset 0 0 0 2px rgba(255,255,255,.06), 0 6px 12px rgba(0,0,0,.35);
  }
  body.theme-moon .plot.ring::after{
    border-color:#cbb2ff88;
  }

  /* ===== Theme picker tiles ===== */
  .themeCard{
    border:3px solid var(--accent);
    border-radius:12px;
    padding:12px;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .themeCard h3{
    margin:0;
    font-size:18px;
    font-weight:700;
  }
  .themeCard p{
    margin:0;
    font-size:13px;
    opacity:.85;
  }
  .themeCard .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }

  /* swatch preview */
  .theme-swatch{
    height:90px;
    border-radius:10px;
    border:2px solid currentColor;
    position:relative;
    overflow:hidden;
  }

  /* Pastel preview (Enchanted Pastel) */
  .theme-swatch--pastel{
    color:#d8b4f8; /* border color */
    background:
      linear-gradient(135deg,#ffe6f0,#e6f7ff);
  }
  .theme-swatch--pastel::after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,.65), transparent 70%) repeat,
      radial-gradient(1px 1px at 70% 60%, rgba(255,255,255,.45), transparent 70%) repeat;
    background-size:64px 64px, 96px 96px;
    opacity:.25;
  }

  /* Moonlit Meadow preview */
  .theme-swatch--moon{
    color:#cbb2ff; /* border color */
    background:
      linear-gradient(135deg,#0f1024,#1c2250);
  }
  .theme-swatch--moon::after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(1px 1px at 20% 30%, #ffffffcc, transparent 70%) repeat,
      radial-gradient(1px 1px at 70% 60%, #ffffff99, transparent 70%) repeat;
    background-size:64px 64px, 96px 96px;
    opacity:.9;
  }

  /* Buttons inside cards */
  .themeCard button{
    padding:8px 10px; border:none; border-radius:10px; background:var(--btn);
    font-weight:600; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,.12);
  }
  .themeCard button:hover{ transform:scale(1.04); background:var(--btn2); }
  .themeCard button[disabled]{ opacity:.6; cursor:not-allowed; transform:none; }
</style>
</head>
<body>
  <!-- Fireflies -->
  <script>
    for(let i=0;i<16;i++){
      const f=document.createElement('div'); f.className='firefly';
      f.style.left=Math.random()*100+'vw'; f.style.animationDuration=(8+Math.random()*5)+'s';
      document.body.appendChild(f);
    }
  </script>

  <!-- Start Screen -->
  <div id="start">
    <div class="panel">
      <h1>Andi's Starlight Garden 🧚‍♀️</h1>
      <div class="best" id="bestOnStart">Best: 0</div>
      <p>Grow mushrooms, invite fairies, befriend frogs — and bask in the glow ✨</p>

      <!-- Name your garden -->
      <div class="nameRow">
        <label for="gardenNameInput">Garden name:</label>
        <input id="gardenNameInput" type="text" maxlength="60" placeholder="Name your garden…">
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
        <button id="btnStart">Start Garden</button>
        <button id="btnHowtoStart">How to Play</button>
        <button id="btnCreditsStart">Credits</button>
      </div>
    </div>
  </div>

  <!-- Confetti -->
  <canvas id="fxCanvas"></canvas>

  <div class="wrap" id="app" style="display:none">
    <div id="topBar">
      <div>
        <div id="scoreTop">Starlight: <span id="starlight">0</span></div>
        <div id="bestBadge">👑 Best: <span id="best">0</span> · +<span id="rate">0</span>/s · +<span id="tap">0</span>/tap</div>
      </div>
      <div>
        <button id="howtoBtn">How to Play</button>
        <button id="themeBtn">Select Theme</button>
        <button id="musicBtn">🔊 Music On</button>
        <button id="resetBtn" title="Reset progress">Reset</button>
      </div>
    </div>

    <!-- Garden display name + Rename -->
    <div class="titleRow">
      <h2 id="gardenTitle" class="garden-title"></h2>
      <button id="renameBtn" class="renameBtn" title="Rename your garden">✏️ Rename</button>
    </div>
    <!-- Inline rename editor -->
    <div id="renameEditor" class="renameRow" style="display:none;">
      <input id="renameInput" type="text" maxlength="60" placeholder="Enter a new garden name…">
      <button id="renameSave">Save</button>
      <button id="renameCancel">Cancel</button>
    </div>

    <div id="garden">
      <div class="plots" id="plots"></div>
    </div>

    <!-- Collect lives here, under the grid -->
    <button id="collectBtn">Collect Starlight ✨</button>

    <div class="shop">
      <div class="card">
        <h3 id="labelMush">🍄 Mushrooms</h3>
        <p id="descMush">+1 starlight / sec</p>
        <p>Owned: <span id="mushCnt">0</span> · Cost: <span id="mushCost">10</span></p>
        <button class="buyBtn" id="buyMush">Plant Mushroom</button>
      </div>
      <div class="card">
        <h3 id="labelFairy">🧚 Fairies</h3>
        <p id="descFairy">+3 starlight / sec</p>
        <p>Invited: <span id="fairyCnt">0</span> · Cost: <span id="fairyCost">50</span></p>
        <button class="buyBtn" id="buyFairy">Invite Fairy</button>
      </div>
      <div class="card">
        <h3 id="labelFrog">🐸 Frogs</h3>
        <p id="descFrog">+1 starlight / tap</p>
        <p>Friends: <span id="frogCnt">0</span> · Cost: <span id="frogCost">30</span></p>
        <button class="buyBtn" id="buyFrog">Befriend Frog</button>
      </div>

      <!-- Mermaids (unlock at 1,000,000 lifetime) -->
      <div class="card" id="cardMermaid">
        <h3 id="labelMermaid">🧜‍♀️ Mermaids</h3>
        <p id="descMermaid">+25 starlight / sec</p>
        <p>
          Allies: <span id="mermaidCnt">0</span> ·
          Cost: <span id="mermaidCost">100,000</span>
        </p>
        <button class="buyBtn" id="buyMermaid" disabled title="Reach 1,000,000 total to unlock">Summon Mermaid</button>
        <p id="mermaidLockText" style="margin-top:6px; font-size:13px; opacity:.8">
          🔒 Unlock at 1,000,000 total starlight (Progress:
          <span id="mermaidProg">0%</span>)
        </p>
      </div>
    </div>
  </div>

  <!-- How To Modal (updated) -->
  <div class="backdrop" id="howto">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
      <h2 id="howtoTitle">How to Play 🌟</h2>
      <ul>
        <li><b>Goal:</b> Use Starlight to grow your garden. Plant mushrooms, invite fairies, and befriend frogs.</li>
        <li><b>Collect:</b> Tap the big button to gather Starlight.</li>
        <li><b>Idle:</b> The garden keeps growing when closed — you’ll get offline earnings next time.</li>
        <li><b>Idle Faster:</b> 🍄 Mushrooms +1/s, 🧚 Fairies +3/s, 🐸 Frogs +1/tap.</li>
        <li><b>Bonus Theme:</b> Unlock Moonlit Meadow after gaining 50,000 Starlight.</li>
        <li><b>Unlock:</b> Unlock Mermaids 🧜‍♀️ after gaining 1,000,000 Starlight.</li>
        <li><b>Zen:</b> Growing a Starlight Garden brings you joy and the tranquility you seek.</li>
      </ul>
      <div class="actions"><button id="closeHowto">Got it ✨</button></div>
    </div>
  </div>

  <!-- Credits Modal -->
  <div class="backdrop" id="credits">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="creditsTitle">
      <h2 id="creditsTitle">Credits 🌙</h2>
      <ul>
        <li><b>Garden Keeper & Producer:</b> Andi M.C. 🧜‍♀️</li>
        <li><b>Design & Code:</b> Andi + a committee of very opinionated frogs 🐸 (OpenAI)</li>
        <li><b>Ambient Vibes:</b> Tokyo Lofi</li>
        <li><b>Special Thanks:</b> Everyone who watered the mushrooms and didn’t sit on the fairies</li>
      </ul>
      <div class="actions"><button id="closeCredits">Back</button></div>
    </div>
  </div>

  <!-- Theme Modal -->
  <div class="backdrop" id="themeModal" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="themeTitle">
      <h2 id="themeTitle">Select Theme ✨</h2>
      <div id="themeGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;">
        <!-- tiles injected by JS -->
      </div>
      <div class="actions" style="margin-top:12px">
        <button id="closeTheme">Close</button>
      </div>
    </div>
  </div>

<script>
  // ====== State & Utilities ======
  const KEY = 'starlight_garden_state_v1';
  const FX = document.getElementById('fxCanvas');
  const FXX = FX.getContext('2d');

  const els = {
    app: document.getElementById('app'),
    plots: document.getElementById('plots'),
    starlight: document.getElementById('starlight'),
    best: document.getElementById('best'),
    rate: document.getElementById('rate'),
    tap: document.getElementById('tap'),
    bestOnStart: document.getElementById('bestOnStart'),
    mushCnt: document.getElementById('mushCnt'),
    mushCost: document.getElementById('mushCost'),
    fairyCnt: document.getElementById('fairyCnt'),
    fairyCost: document.getElementById('fairyCost'),
    frogCnt: document.getElementById('frogCnt'),
    frogCost: document.getElementById('frogCost'),
    howto: document.getElementById('howto'),
    earningsLine: document.getElementById('earningsLine'),

    credits: document.getElementById('credits'),

    // Name input + display
    gardenNameInput: document.getElementById('gardenNameInput'),
    gardenTitle: document.getElementById('gardenTitle'),

    // Rename UI
    renameBtn: document.getElementById('renameBtn'),
    renameEditor: document.getElementById('renameEditor'),
    renameInput: document.getElementById('renameInput'),
    renameSave: document.getElementById('renameSave'),
    renameCancel: document.getElementById('renameCancel'),

    // Theme UI
    themeBtn: document.getElementById('themeBtn'),
    themeModal: document.getElementById('themeModal'),
    themeGrid: document.getElementById('themeGrid'),
    closeTheme: document.getElementById('closeTheme'),

    // Mermaid UI
    mermaidCnt: document.getElementById('mermaidCnt'),
    mermaidCost: document.getElementById('mermaidCost'),
    buyMermaid: document.getElementById('buyMermaid'),
    mermaidProg: document.getElementById('mermaidProg'),
    mermaidLockText: document.getElementById('mermaidLockText'),

    // Shop labels (dynamic per theme)
    labelMush: document.getElementById('labelMush'),
    labelFairy: document.getElementById('labelFairy'),
    labelFrog: document.getElementById('labelFrog'),
    labelMermaid: document.getElementById('labelMermaid'),
    descMush: document.getElementById('descMush'),
    descFairy: document.getElementById('descFairy'),
    descFrog: document.getElementById('descFrog'),
    descMermaid: document.getElementById('descMermaid'),
  };

  let S = loadState();
  let lastTick = performance.now();
  let loopId = null;
  let intervalId = null; // fallback when hidden / iOS throttles
  let carryPerSec = 0;   // accumulate fractional gains to whole integers
  let celebratedThisSession = false;

  // Music
  let music = null, musicOn = false;

  // Pop SFX
  let audioCtx = null;
  function playPop(pitch = 520){
    try{
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      const base = pitch * (0.9 + Math.random()*0.2);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(base, t);
      osc.frequency.exponentialRampToValueAtTime(base / 2, t + 0.08);

      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(0.18, t + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.16);

      osc.connect(gain).connect(audioCtx.destination);
      osc.start(t);
      osc.stop(t + 0.18);
    } catch(e) { /* ignore */ }
  }

  // ====== Helpers & Layout Guards ======
  function rand(min, max){ return Math.random() * (max - min) + min; }
  function clamp(v, min, max){ return Math.min(Math.max(v, min), max); }

  // map normalized [0,1] to pixels with padding
  function lerpPosition(nx, plotW, sprW, pad){
    const min = pad;
    const max = Math.max(pad, plotW - sprW - pad);
    return min + nx * (max - min);
  }

  // Track current column layout so we only rebuild on actual breakpoint changes
  let COLS = null;
  function computeCols(){
    return window.matchMedia('(max-width: 560px)').matches ? 4 : 5;
  }

  function debounce(fn, ms=120){
    let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
  }

  let _lastPlotsW = 0;

  // ===== THEME REGISTRY & SPRITES =====
  const THEME_PRICE = 50000;
  const THEMES = [
    { id:'default', name:'Enchanted Pastel', class:'theme-default', description:'Original soft pastels' },
    { id:'moon',    name:'Moonlit Meadow',   class:'theme-moon',    description:'Deep indigo night with twinkling stars' },
  ];

  // Emoji & label mapping per theme
  const SPRITES = {
    default: { mush:'🍄', fairy:'🧚‍♀️', frog:'🐸', mermaid:'🧜‍♀️' },
    moon:    { mush:'🪻', fairy:'👻',    frog:'🦉', mermaid:'👽'   },
  };
  const LABELS = {
    default: {
      mush: {title:'🍄 Mushrooms', verb:'Plant Mushroom'},
      fairy:{title:'🧚 Fairies',  verb:'Invite Fairy'},
      frog: {title:'🐸 Frogs',    verb:'Befriend Frog'},
      mermaid:{title:'🧜‍♀️ Mermaids', verb:'Summon Mermaid'}
    },
    moon: {
      mush: {title:'🪻 Lilacs',   verb:'Plant Lilac'},
      fairy:{title:'👻 Ghosts',   verb:'Invite Ghost'},
      frog: {title:'🦉 Owls',     verb:'Befriend Owl'},
      mermaid:{title:'👽 Aliens', verb:'Signal Alien'}
    }
  };
  function themeId(){ return (S.themes?.current) || 'default'; }
  function spriteFor(type){ return (SPRITES[themeId()]||SPRITES.default)[type]; }
  function labelsFor(type){ return (LABELS[themeId()]||LABELS.default)[type]; }

  // ===== Build plots (CSS controls columns; JS respects breakpoint) ======
  function chooseBiome(){
    const r = Math.random();
    if (r < 0.50) return 'glade';
    if (r < 0.68) return 'grove';
    if (r < 0.83) return 'ring';
    if (r < 0.93) return 'pond';
    return 'crystal';
  }

  function buildPlots(force=false){
    const cols = computeCols();

    // Only rebuild if breakpoint changed or forced
    if (!force && COLS === cols) {
      refreshSprites();
      recenterSprites();
      _lastPlotsW = Math.round(els.plots.clientWidth);
      return;
    }
    COLS = cols;

    els.plots.innerHTML = '';
    const total = cols * (cols === 4 ? 4 : 5);

    for(let i=0;i<total;i++){
      const d=document.createElement('div');
      d.className='plot ' + chooseBiome();
      d.dataset.idx=i;
      els.plots.appendChild(d);
    }

    refreshSprites();
    recenterSprites();
    _lastPlotsW = Math.round(els.plots.clientWidth);
  }

  // ====== State load/save ======
  function loadState(){
    try{
      const raw = localStorage.getItem(KEY);
      if(raw){
        const obj = JSON.parse(raw);
        const now = Date.now();
        const elapsed = Math.max(0, Math.floor((now - (obj.last||now))/1000));
        obj.amount = (obj.amount||0) + (obj.perSec||0) * elapsed;            // offline
        obj.totalEarned = (obj.totalEarned || 0) + (obj.perSec||0) * elapsed; // lifetime
        obj.gardenName = obj.gardenName || "Andi's Starlight Garden";    // default name
        obj.themes = obj.themes || { unlocked:['default'], current:'default' };
        obj.last = now;
        localStorage.setItem(KEY, JSON.stringify(obj));
        return obj;
      }
    }catch(e){}
    return {
      amount:0, best:0, perSec:0, perTap:1,
      mush:0, fairy:0, frog:0, mermaid:0,
      totalEarned: 0,
      gardenName: "Andi's Starlight Garden",
      themes: { unlocked:['default'], current:'default' },
      last:Date.now()
    };
  }
  function saveState(){ S.last = Date.now(); localStorage.setItem(KEY, JSON.stringify(S)); }
  function resetState(){
    if(confirm('Reset your Starlight Garden progress?')){
      localStorage.removeItem(KEY);
      S = {
        amount:0, best:0, perSec:0, perTap:1,
        mush:0, fairy:0, frog:0, mermaid:0,
        totalEarned: 0,
        gardenName: "Andi's Starlight Garden",
        themes: { unlocked:['default'], current:'default' },
        last:Date.now()
      };
      celebratedThisSession = false;
      updateUI(); refreshSprites(); recenterSprites(); applyTheme(S.themes.current);
    }
  }

  // ====== Costs/UI ======
  const UNLOCK_MERMAID_AT = 1_000_000;

  const base = { mush:10, fairy:50, frog:30, mermaid:100000 };
  function costOf(type,count){
    const f = {mush:1.15, fairy:1.18, frog:1.16, mermaid:1.22}[type];
    return Math.floor(base[type] * Math.pow(f, count));
  }

  function n(x){ return Math.floor(x).toLocaleString(); }

  function isMermaidUnlocked(){ return (S.totalEarned || 0) >= UNLOCK_MERMAID_AT; }

  function updateUI(){
    document.getElementById('starlight').textContent = n(S.amount);
    document.getElementById('best').textContent = n(S.best);
    document.getElementById('rate').textContent = n(S.perSec);
    document.getElementById('tap').textContent = n(S.perTap);
    document.getElementById('bestOnStart').textContent = 'Best: ' + n(S.best);

    // update name input + title
    if (els.gardenNameInput && document.getElementById('start').style.display !== 'none') {
      els.gardenNameInput.value = S.gardenName || "";
    }
    els.gardenTitle.textContent = S.gardenName || "";

    document.getElementById('mushCnt').textContent = S.mush;
    document.getElementById('fairyCnt').textContent = S.fairy;
    document.getElementById('frogCnt').textContent = S.frog;

    els.mermaidCnt.textContent = S.mermaid || 0;

    document.getElementById('mushCost').textContent = n(costOf('mush',S.mush));
    document.getElementById('fairyCost').textContent = n(costOf('fairy',S.fairy));
    document.getElementById('frogCost').textContent = n(costOf('frog',S.frog));

    els.mermaidCost.textContent = n(costOf('mermaid', S.mermaid || 0));

    const unlocked = isMermaidUnlocked();
    els.buyMermaid.disabled = !unlocked || S.amount < costOf('mermaid', S.mermaid||0);
    els.mermaidLockText.style.display = unlocked ? 'none' : 'block';

    const prog = Math.min(100, Math.floor(((S.totalEarned||0)/UNLOCK_MERMAID_AT)*100));
    els.mermaidProg.textContent = prog + '%';

    refreshThemeUI(); // sync labels/icons with theme
  }

  function refreshThemeUI(){
    const L = labelsFor('mush'); els.labelMush.textContent = L.title; document.getElementById('buyMush').textContent = L.verb;
    const L2 = labelsFor('fairy'); els.labelFairy.textContent = L2.title; document.getElementById('buyFairy').textContent = L2.verb;
    const L3 = labelsFor('frog'); els.labelFrog.textContent = L3.title; document.getElementById('buyFrog').textContent = L3.verb;
    const L4 = labelsFor('mermaid'); els.labelMermaid.textContent = L4.title; document.getElementById('buyMermaid').textContent = L4.verb;

    // descriptions keep the numeric effects
    els.descMush.textContent = '+1 starlight / sec';
    els.descFairy.textContent = '+3 starlight / sec';
    els.descFrog.textContent = '+1 starlight / tap';
    els.descMermaid.textContent = '+25 starlight / sec';

    // Update How-to line emojis
    const e1 = spriteFor('mush'), e2 = spriteFor('fairy'), e3 = spriteFor('frog');
    els.earningsLine.innerHTML = `<b>Idle Faster:</b> ${e1} +1/s, ${e2} +3/s, ${e3} +1/tap.`;
  }

  function maybeBest(){
    if (S.amount > S.best) {
      S.best = S.amount;
      if (!celebratedThisSession) { confetti(); celebratedThisSession = true; }
    }
  }

  // ===== Sprite logic: no edges, no overlaps, stable on resize ======
  function overlaps(a, b, margin = 2){
    const ax = a.left,  ay = a.top,  aw = a.width,  ah = a.height;
    const bx = b.left,  by = b.top,  bw = b.width, bh = b.height;
    return !(ax + aw + margin <= bx ||
             bx + bw + margin <= ax ||
             ay + ah + margin <= by ||
             by + bh + margin <= ay);
  }

  function getSpanBox(span){
    return {
      left: parseFloat(span.style.left) || 0,
      top:  parseFloat(span.style.top)  || 0,
      width: span.offsetWidth,
      height: span.offsetHeight
    };
  }

  function placeSpriteFor(type){
    const plots = document.querySelectorAll('.plot');
    if(!plots.length) return;

    const p = plots[Math.floor(Math.random()*plots.length)];
    const floating = (type === 'fairy' || type === 'mermaid'); // ghosts/aliens float in moon theme
    const span = document.createElement('span');
    span.className = 'spr' + (floating ? ' float' : '');
    span.dataset.type = type;
    span.textContent = spriteFor(type);
    span.style.visibility = 'hidden';
    span.style.left = '0px';
    span.style.top  = '0px';
    p.appendChild(span);

    const rect = p.getBoundingClientRect();
    const sprW = span.offsetWidth;
    const sprH = span.offsetHeight;

    const PAD = 8;
    const bobRoom = floating ? 8 : 0;

    const maxX = Math.max(PAD, rect.width  - sprW - PAD);
    const maxY = Math.max(PAD, rect.height - sprH - PAD - bobRoom);

    const existing = Array.from(p.querySelectorAll('.spr')).filter(s => s !== span);
    const attempts = 20;
    let x = PAD, y = PAD;

    for(let i=0;i<attempts;i++){
      const tryX = rand(PAD, maxX);
      const tryY = rand(PAD + bobRoom, maxY);
      const candidate = { left: tryX, top: tryY, width: sprW, height: sprH };
      const hit = existing.some(other => overlaps(candidate, getSpanBox(other), 3));
      if (!hit){ x = tryX; y = tryY; break; }
    }

    // Save normalized coords so we can restore stable relative positions on resize
    const nx = (x - PAD) / Math.max(1, (rect.width  - sprW - PAD*2));
    const ny = (y - PAD - bobRoom) / Math.max(1, (rect.height - sprH - PAD*2 - bobRoom));

    span.dataset.nx = String(Math.min(1, Math.max(0, nx)));
    span.dataset.ny = String(Math.min(1, Math.max(0, ny)));
    span.dataset.bob = floating ? '1' : '0';

    span.style.left = `${x}px`;
    span.style.top  = `${y}px`;
    span.style.visibility = 'visible';
  }

  function refreshSprites(){
    document.querySelectorAll('.spr').forEach(x=>x.remove());
    for(let i=0;i<S.mush;i++)   placeSpriteFor('mush');
    for(let i=0;i<S.fairy;i++)  placeSpriteFor('fairy');
    for(let i=0;i<S.frog;i++)   placeSpriteFor('frog');
    for(let i=0;i<S.mermaid;i++)placeSpriteFor('mermaid');
  }

  function recenterSprites(){
    const PAD = 8;
    document.querySelectorAll('.plot').forEach(p => {
      const rect = p.getBoundingClientRect();
      const sprites = Array.from(p.querySelectorAll('.spr'));

      // Restore from normalized coords, also swap emoji per theme
      sprites.forEach(span => {
        const sprW = span.offsetWidth;
        const sprH = span.offsetHeight;
        const bobRoom = span.dataset.bob === '1' ? 8 : 0;

        // Ensure emoji matches the current theme but keep placement
        if (span.dataset.type) span.textContent = spriteFor(span.dataset.type);

        const nx = span.dataset.nx != null ? parseFloat(span.dataset.nx) : 0.5;
        const ny = span.dataset.ny != null ? parseFloat(span.dataset.ny) : 0.5;

        const left = lerpPosition(nx, rect.width,  sprW, PAD);
        const top  = lerpPosition(ny, rect.height - bobRoom, sprH, PAD) + bobRoom;

        span.style.left = `${left}px`;
        span.style.top  = `${top}px`;
      });

      // Gentle de-overlap pass, then update normalized to persist nudges
      const maxIters = 16;
      for (let iter=0; iter<maxIters; iter++){
        let anyMoved = false;
        for (let i=0;i<sprites.length;i++){
          for (let j=i+1;j<sprites.length;j++){
            const a = sprites[i], b = sprites[j];
            const abox = getSpanBox(a);
            const bbox = getSpanBox(b);
            if (overlaps(abox, bbox, 2)){
              const dx = (abox.left + abox.width/2) - (bbox.left + bbox.width/2);
              const dy = (abox.top  + abox.height/2) - (bbox.top  + bbox.height/2);
              const len = Math.max(1, Math.hypot(dx,dy));
              const ux = dx / len, uy = dy / len;
              const push = 4;

              let aX = parseFloat(a.style.left) || 0;
              let aY = parseFloat(a.style.top)  || 0;
              let bX = parseFloat(b.style.left) || 0;
              let bY = parseFloat(b.style.top)  || 0;

              const aBob = a.dataset.bob === '1' ? 8 : 0;
              const bBob = b.dataset.bob === '1' ? 8 : 0;

              const aW = a.offsetWidth, aH = a.offsetHeight;
              const bW = b.offsetWidth, bH = b.offsetHeight;

              const aMaxX = Math.max(PAD, rect.width  - aW - PAD);
              const aMaxY = Math.max(PAD, rect.height - aH - PAD - aBob);
              const bMaxX = Math.max(PAD, rect.width  - bW - PAD);
              const bMaxY = Math.max(PAD, rect.height - bH - PAD - bBob);

              aX = clamp(aX + ux*push, PAD, aMaxX);
              aY = clamp(aY + uy*push, PAD + aBob, aMaxY);
              bX = clamp(bX - ux*push, PAD, bMaxX);
              bY = clamp(bY - uy*push, PAD + bBob, bMaxY);

              a.style.left = `${aX}px`; a.style.top = `${aY}px`;
              b.style.left = `${bX}px`; b.style.top = `${bY}px`;
              anyMoved = true;

              // update normalized after nudge so future resizes keep this separation
              a.dataset.nx = String((aX - PAD) / Math.max(1, (rect.width  - aW - PAD*2)));
              a.dataset.ny = String((aY - PAD - aBob) / Math.max(1, (rect.height - aH - PAD*2 - aBob)));
              b.dataset.nx = String((bX - PAD) / Math.max(1, (rect.width  - bW - PAD*2)));
              b.dataset.ny = String((bY - PAD - bBob) / Math.max(1, (rect.height - bH - PAD*2 - bBob)));
            }
          }
        }
        if (!anyMoved) break;
      }
    });
  }

  // ====== Confetti ======
  function confetti(){
    const w = FX.width = window.innerWidth, h = window.innerHeight;
    FX.height = h;
    const parts = [];
    const colors = ['#ff99cc','#c1f0f6','#f7d9f0','#d4f7d0','#fef3bd','#b39ddb'];
    for(let i=0;i<140;i++){
      const ang = Math.random()*Math.PI - Math.PI/2, sp = 6+Math.random()*6;
      parts.push({x:w/2,y:h*0.25,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp-2,g:.25+Math.random()*.2,life:60+Math.random()*40,c:colors[Math.floor(Math.random()*colors.length)],s:4+Math.random()*4,r:Math.random()*Math.PI,vr:(Math.random()-.5)*.3});
    }
    (function tick(){
      FXX.clearRect(0,0,w,h);
      parts.forEach(p=>{p.vy+=p.g;p.x+=p.vx;p.y+=p.vy;p.r+=p.vr;p.life--;
        FXX.save();FXX.translate(p.x,p.y);FXX.rotate(p.r);
        FXX.fillStyle=p.c;FXX.fillRect(-p.s/2,-p.s/2,p.s,p.s*1.6);FXX.restore();
      });
      for(let i=parts.length-1;i>=0;i--) if(parts[i].life<=0||parts[i].y>h+40) parts.splice(i,1);
      if(parts.length) requestAnimationFrame(tick); else FXX.clearRect(0,0,w,h);
    })();
  }

  // ====== Game Loop (robust accrual) ======
  function loop(ts){
    const dt = Math.max(0,(ts - lastTick)/1000);
    lastTick = ts;

    // accumulate fractional perSec, apply whole amounts
    carryPerSec += (S.perSec * dt);
    const whole = Math.floor(carryPerSec);
    if (whole > 0) {
      S.amount += whole;
      S.totalEarned = (S.totalEarned || 0) + whole;
      carryPerSec -= whole;
    }

    maybeBest();
    updateUI();

    loopId = requestAnimationFrame(loop);
  }

  function startGameLoop(){
    if (loopId) cancelAnimationFrame(loopId);
    if (intervalId) { clearInterval(intervalId); intervalId = null; }
    lastTick = performance.now();
    loopId = requestAnimationFrame(loop);
  }

  // keep accrual going if tab hidden / rAF throttled
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      if (!intervalId) intervalId = setInterval(() => loop(performance.now()), 250);
    } else {
      if (intervalId) { clearInterval(intervalId); intervalId = null; }
      if (!loopId) startGameLoop();
    }
  });

  // ====== Actions ======
  function sanitizeName(s){
    if (!s) return "Andi's Starlight Garden";
    s = s.trim().replace(/\s+/g, ' ');
    return s.slice(0, 60);
  }

  function openRename(){
    els.renameInput.value = S.gardenName || "";
    els.renameEditor.style.display = 'flex';
    // focus after frame to ensure visibility on iOS
    setTimeout(() => {
      els.renameInput.focus();
      els.renameInput.select();
      els.renameEditor.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 0);
  }
  function closeRename(){ els.renameEditor.style.display = 'none'; }
  function saveRename(){
    const newName = sanitizeName(els.renameInput.value);
    S.gardenName = newName;
    saveState();
    updateUI();
    closeRename();
  }

  function collect(){
    S.amount += S.perTap;
    S.totalEarned = (S.totalEarned || 0) + S.perTap; // lifetime taps
    playPop(540);
    maybeBest(); updateUI(); saveState();
  }

  function buy(type){
    const cost = costOf(type, S[type] || 0);

    // Gate mermaid by lifetime unlock
    if (type === 'mermaid' && !isMermaidUnlocked()) return;

    if(S.amount < cost) return;

    S.amount -= cost;
    S[type] = (S[type] || 0) + 1;

    if(type==='mush')   { S.perSec += 1;  placeSpriteFor('mush');             playPop(420); }
    if(type==='fairy')  { S.perSec += 3;  placeSpriteFor('fairy');            playPop(650); }
    if(type==='frog')   { S.perTap += 1;  placeSpriteFor('frog');             playPop(320); }
    if(type==='mermaid'){ S.perSec += 25; placeSpriteFor('mermaid');          playPop(560); }

    recenterSprites();
    updateUI(); saveState();
  }

  // Music
  function ensureMusic(){
    if(!music){ music = new Audio('Tokyo.mp3'); music.loop = true; music.volume = .6; }
    music.play().then(()=>{musicOn=true;document.getElementById('musicBtn').textContent='🔊 Music On'}).catch(()=>{});
  }
  function toggleMusic(){
    if(!music) return;
    if(musicOn){ music.pause(); musicOn=false; document.getElementById('musicBtn').textContent='🔇 Music Off'; }
    else { music.play().catch(()=>{}); musicOn=true; document.getElementById('musicBtn').textContent='🔊 Music On'; }
  }

  // Tap sparkles (kept for desktop clicks; touch handler below)
  function sparkleAt(x,y){
    for(let i=0;i<6;i++){
      const s = document.createElement('div');
      s.className='spark';
      s.textContent = ['✨','💫','⭐'][Math.floor(Math.random()*3)];
      s.style.left = x + (Math.random()*24-12) + 'px';
      s.style.top  = y + (Math.random()*10-5)  + 'px';
      document.body.appendChild(s);
      setTimeout(()=>s.remove(),800);
    }
  }

  // ====== Start/Modal ======
  function openHowto(){ els.howto.style.display='flex'; }
  function closeHowto(){ els.howto.style.display='none'; }
  function openCredits(){ els.credits.style.display='flex'; }
  function closeCredits(){ els.credits.style.display='none'; }

  // Ensure the typed name is saved & shown immediately on Start
  function startGame(){
    if (els.gardenNameInput) {
      els.gardenNameInput.blur();
      const typed = sanitizeName(els.gardenNameInput.value);
      if (typed) S.gardenName = typed;
      saveState();
      els.gardenTitle.textContent = S.gardenName || "";
    }

    document.getElementById('start').style.display='none';
    document.getElementById('app').style.display='block';
    celebratedThisSession = false;
    ensureMusic(); buildPlots(true); updateUI();
    startGameLoop();
  }

  // ====== THEME: apply/unlock/UI ======
  function isUnlocked(id){ return (S.themes?.unlocked || []).includes(id); }
  function canAffordTheme(){ return S.amount >= THEME_PRICE; }
  function unlockTheme(id){
    if (isUnlocked(id)) return true;
    if (!canAffordTheme()) return false;
    S.amount -= THEME_PRICE;
    S.themes.unlocked.push(id);
    saveState(); updateUI();
    return true;
  }
  function applyTheme(id){
    const t = THEMES.find(x=>x.id===id) || THEMES[0];
    // remove any old theme-* class
    document.body.classList.forEach(c => { if (c.startsWith('theme-')) document.body.classList.remove(c); });
    if (t.class && t.class !== 'theme-default') document.body.classList.add(t.class);
    S.themes.current = t.id; saveState();
    // Update sprite glyphs without losing positions
    recenterSprites();
    refreshThemeUI();
  }

  function renderThemeModal(){
    els.themeGrid.innerHTML = '';

    // tiny style presets just for the tile chrome
    const CARD_STYLES = {
      default: { panel:'#fff7fb', border:'#d8b4f8', text:'#5b2b86', swatchClass:'theme-swatch--pastel' },
      moon:    { panel:'#151a3a', border:'#cbb2ff', text:'#eae6ff', swatchClass:'theme-swatch--moon' },
    };

    THEMES.forEach(t=>{
      const unlocked = (t.id === 'default') ? true : isUnlocked(t.id);   // default always unlocked
      const active = S.themes.current === t.id;
      const cs = CARD_STYLES[t.id] || CARD_STYLES.default;

      const card = document.createElement('div');
      card.className = 'themeCard';
      card.style.background = cs.panel;
      card.style.borderColor = cs.border;
      card.style.color = cs.text;

      card.innerHTML = `
        <h3>${t.name} ${active ? '🌟' : ''}</h3>
        <div class="theme-swatch ${cs.swatchClass}"></div>
        <p>${t.description}</p>
        <div class="actions">
          ${
            unlocked
              ? `<button class="applyBtn" ${active ? 'disabled' : ''}>${active ? 'Active' : 'Apply'}</button>`
              : `<button class="buyBtn" ${canAffordTheme()?'':'disabled'}>Unlock — ${THEME_PRICE.toLocaleString()} ✨</button>`
          }
        </div>
      `;

      const btn = card.querySelector('button');
      btn.addEventListener('click', ()=>{
        if (unlocked) {
          if (!active) { applyTheme(t.id); }
        } else {
          if (unlockTheme(t.id)) { applyTheme(t.id); }
        }
        renderThemeModal(); // refresh UI to reflect state change
      });

      els.themeGrid.appendChild(card);
    });
  }
  function openThemeModal(){ renderThemeModal(); els.themeModal.style.display='flex'; }
  function closeThemeModal(){ els.themeModal.style.display='none'; }

  // ====== Smart resize handling (no flashing on iOS scroll) ======
  const handleResize = debounce(() => {
    // Keep canvas matched (cheap)
    FX.width = window.innerWidth; 
    FX.height = window.innerHeight;

    const breakpointChanged = computeCols() !== COLS;

    // Check width of plots container; ignore height-only jiggle
    const plotsW = els.plots ? Math.round(els.plots.clientWidth) : 0;
    const plotsWidthChanged = Math.abs(plotsW - _lastPlotsW) >= 1;

    if (breakpointChanged) {
      buildPlots(true);           // 4↔5 columns: rebuild
    } else if (plotsWidthChanged) {
      recenterSprites();          // width changed (e.g., rotation): recompute positions
      _lastPlotsW = plotsW;
    }
  }, 120);

  window.addEventListener('resize', handleResize, { passive: true });
  window.addEventListener('orientationchange', () => buildPlots(true), { passive: true });

  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(recenterSprites);
  }

  // ====== Wire UI ======
  document.getElementById('btnStart').addEventListener('click', startGame);
  document.getElementById('btnHowtoStart').addEventListener('click', openHowto);
  document.getElementById('howtoBtn').addEventListener('click', openHowto);
  document.getElementById('closeHowto').addEventListener('click', closeHowto);

  document.getElementById('btnCreditsStart').addEventListener('click', openCredits);
  document.getElementById('closeCredits').addEventListener('click', closeCredits);

  els.themeBtn.addEventListener('click', openThemeModal);
  els.closeTheme.addEventListener('click', closeThemeModal);

  document.getElementById('musicBtn').addEventListener('click', toggleMusic);
  document.getElementById('resetBtn').addEventListener('click', resetState);

  // Pressing Enter in the start-name field starts the game immediately
  els.gardenNameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      startGame();
    }
  });

  // Rename handlers
  els.renameBtn.addEventListener('click', openRename);
  els.renameSave.addEventListener('click', saveRename);
  els.renameCancel.addEventListener('click', closeRename);
  els.renameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); saveRename(); }
    if (e.key === 'Escape') { e.preventDefault(); closeRename(); }
  });

  // Guard against scroll-jumps while pressing Collect on iOS
  const cb = document.getElementById('collectBtn');
  cb.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });
  cb.addEventListener('touchend', (e) => {
    e.preventDefault();
    collect();
  }, { passive: false });
  cb.addEventListener('click', collect);

  document.getElementById('buyMush').addEventListener('click', ()=>buy('mush'));
  document.getElementById('buyFairy').addEventListener('click', ()=>buy('fairy'));
  document.getElementById('buyFrog').addEventListener('click', ()=>buy('frog'));
  document.getElementById('buyMermaid').addEventListener('click', ()=>buy('mermaid'));
  document.getElementById('garden').addEventListener('click', (e)=>{ /* reserved for future tap fx */ });

  // ====== Init ======
  els.gardenNameInput.value = S.gardenName || "";
  updateUI();
  buildPlots(true);
  applyTheme(S.themes?.current || 'default');
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
</script>
</body>
</html>
